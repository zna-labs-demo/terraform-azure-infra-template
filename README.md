# Infrastructure Repository

This repository was automatically provisioned by the **Subscription Vending** process and contains Terraform configuration for your Azure infrastructure.

## Quick Start

### 1. Clone and Create a Feature Branch

```bash
git clone <this-repo-url>
cd <repo-name>
git checkout -b feature/add-my-resource
```

### 2. Make Your Changes

Edit the Terraform files to add your infrastructure. The `main.tf` file is your starting point.

### 3. Run Local Quality Checks

```bash
# Format your code
terraform fmt -recursive

# Validate configuration
terraform init -backend=false
terraform validate

# Run linting (if tflint installed)
tflint --init
tflint
```

### 4. Commit and Push

```bash
git add .
git commit -m "feat: add storage account for application data"
git push -u origin feature/add-my-resource
```

### 5. Create a Pull Request

Open a PR in GitHub. The Azure DevOps pipeline will automatically:
- Check Terraform formatting
- Validate configuration
- Run TFLint static analysis
- Perform security scanning with tfsec

### 6. Merge to Main

Once approved and merged, Terraform Cloud will automatically:
- Generate a plan
- Apply changes (if auto-apply is enabled) or wait for approval

---

## Repository Structure

```
.
├── main.tf              # Primary infrastructure resources
├── variables.tf         # Input variable definitions
├── locals.tf            # Computed local values
├── outputs.tf           # Output value definitions
├── providers.tf         # Provider configuration (Azure, TFC)
├── azure-pipelines.yml  # CI pipeline for quality gates
├── .tflint.hcl         # TFLint configuration
├── .pre-commit-config.yaml  # Pre-commit hooks
└── README.md           # This file
```

## Available Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `app_id` | Application identifier (auto-set by vending) | Required |
| `environment` | Deployment environment | `dev` |
| `location` | Azure region | `eastus` |
| `enable_storage_account` | Create storage account | `false` |
| `enable_key_vault` | Create Key Vault | `false` |

## Enabling Optional Resources

To enable optional resources, update your Terraform Cloud workspace variables:

```hcl
# In TFC workspace or terraform.tfvars
enable_storage_account = true
enable_key_vault       = true
```

## Adding New Resources

1. Add resource definitions to `main.tf` (or create new `.tf` files)
2. Add any new variables to `variables.tf`
3. Add outputs to `outputs.tf`
4. Update `locals.tf` if you need computed values

### Example: Adding a Virtual Network

```hcl
# In main.tf
resource "azurerm_virtual_network" "main" {
  name                = "vnet-${local.name_prefix}"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  address_space       = ["10.0.0.0/16"]
  tags                = local.common_tags
}

resource "azurerm_subnet" "default" {
  name                 = "snet-default"
  resource_group_name  = azurerm_resource_group.main.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.1.0/24"]
}
```

## CI/CD Pipeline

### Pull Request Checks
- **Format**: Ensures consistent code style
- **Validate**: Catches syntax errors
- **TFLint**: Best practice analysis
- **tfsec**: Security vulnerability detection

### Main Branch
- Quality gates must pass
- Terraform Cloud automatically picks up changes
- Plan is generated and (optionally) applied

## Links

- **TFC Workspace**: [View in Terraform Cloud](https://app.terraform.io/app/zna-labs/workspaces)
- **ADO Pipeline**: [View in Azure DevOps](https://dev.azure.com/z-training)
- **Training Docs**: [CI/CD Training](https://dev.azure.com/z-training/cicd-training)

---

<!-- BEGIN_TF_DOCS -->
<!-- This section is auto-generated by terraform-docs -->
<!-- END_TF_DOCS -->
