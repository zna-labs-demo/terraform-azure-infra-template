# =============================================================================
# Azure DevOps CI Pipeline for Terraform Infrastructure
# =============================================================================
# This pipeline runs on every PR and push to main, performing:
# - Terraform format check
# - Terraform validation
# - TFLint static analysis
# - Security scanning with tfsec
# - Cost estimation (on PRs)
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '*.md'
      - '.gitignore'

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VERSION: '1.6.6'
  TFLINT_VERSION: 'v0.50.0'

stages:
  # ===========================================================================
  # Stage 1: Quality Gates
  # ===========================================================================
  - stage: QualityGates
    displayName: 'Quality Gates'
    jobs:
      - job: TerraformFormat
        displayName: 'Terraform Format Check'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              terraform fmt -check -recursive -diff
            displayName: 'Check Terraform Formatting'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: TerraformValidate
        displayName: 'Terraform Validate'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              terraform init -backend=false
            displayName: 'Terraform Init (No Backend)'
            workingDirectory: $(System.DefaultWorkingDirectory)

          - script: |
              terraform validate
            displayName: 'Terraform Validate'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: TFLint
        displayName: 'TFLint Analysis'
        steps:
          - script: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
            displayName: 'Install TFLint'

          - script: |
              tflint --init
              tflint --format compact
            displayName: 'Run TFLint'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: SecurityScan
        displayName: 'Security Scan (tfsec)'
        steps:
          - script: |
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
            displayName: 'Install tfsec'

          - script: |
              tfsec . --format lovely --minimum-severity MEDIUM
            displayName: 'Run tfsec Security Scan'
            workingDirectory: $(System.DefaultWorkingDirectory)
            continueOnError: true  # Don't fail build, just report

  # ===========================================================================
  # Stage 2: Plan (PR Only)
  # ===========================================================================
  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: TerraformPlan
        displayName: 'Generate Plan'
        steps:
          - script: |
              echo "## Terraform Plan Summary" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "Terraform Cloud will generate the actual plan when this PR is merged." >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "### Quality Gate Results" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Format: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Validation: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- TFLint: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Security: Scanned" >> $(System.DefaultWorkingDirectory)/plan-summary.md
            displayName: 'Generate Plan Summary'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/plan-summary.md'
              artifact: 'plan-summary'
            displayName: 'Publish Plan Summary'

  # ===========================================================================
  # Stage 3: Notify (Main Branch Only)
  # ===========================================================================
  - stage: Notify
    displayName: 'Notify TFC'
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: TFCNotification
        displayName: 'TFC Will Apply'
        steps:
          - script: |
              echo "=============================================="
              echo "Quality gates passed!"
              echo "Terraform Cloud will now pick up this change"
              echo "and run plan/apply automatically."
              echo "=============================================="
              echo ""
              echo "Monitor your workspace at:"
              echo "https://app.terraform.io/app/zna-labs/workspaces"
            displayName: 'TFC Notification'
